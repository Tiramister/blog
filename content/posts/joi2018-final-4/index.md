---
title: "JOI 2018 本選 問題 4 - 定期券(Commuter Pass)"
date: 2020-02-11
tags: [joi]
links:
  - label: "Problem link"
    url: "https://onlinejudge.u-aizu.ac.jp/challenges/sources/JOI/Final/0650?year=2018"
  - label: "My Submission"
    url: "https://onlinejudge.u-aizu.ac.jp/solutions/problem/0650/review/4168564/misteer/C++14"
---

## 問題

重み付き単純連結無向グラフ $G = (V, E)$ と， $s, t, a, b \\in V$ が与えられる．グラフの重み関数を $d$ とする．

今からこのグラフに対して，一度だけ以下の操作を行う．

- $st$ 最短パスを 1 つ取る(これを $P$ とおく)．
- $P$ 上の辺の重みを $0$ にする．

操作後の $ab$ 間最短距離として考えうる最小値を求めよ．

### 制約

- $2 \\leq |V| \\leq 10\^5$
- $1 \\leq |E| \\leq 2 \\cdot 10\^5$
- $s \\neq t, a \\neq b$
- $1 \\leq d(e) \\leq 10\^9 \\quad (e \\in E)$

## 考察

まず「 $P$ 上の辺を一切使わないパスが最善の場合」に注意．サンプルにも入っているので良心的．
以降，途中で $P$ 上の辺を使う $ab$ パスのみを考える．

ここで，「 $a$ から $P$ に入った後，一回 $P$ から抜けて再び入る」という移動は無駄であることが重要．抜けずに $P$ 上を移動し続けた方が得だからだ．よって考えるべき $ab$ パスは，ある $x, y \\in V(P)$ によって $a \\to x \\to y \\to b$ という形で表せるものに限られる[^1]．

[^1]: ここで $V(P)$ はパス $P$ 上の頂点集合．

では $x, y \\in P$ となる必要十分条件は何なのかというと，これは距離関数を $dis$ として

$$
dis(s, x) + dis(x, y) + dis(y, t) = dis(s, t)
$$

となる．よって Warshall-Floyd で全点対間距離 $dis$ を求め， $x, y$ を全探索することで $O(n\^3)$ でこの問題が解けた[^2]．

[^2]: これで 100 点中 55 点の部分点が得られる．

しかし，ここから計算量を落とすのがかなり難しい．結論を言うと，

$$
dp\_v = \\min \\\{ dis(a, x) + dis(b, y) \\mid
\\text\{$x, y$を両方通る$sv$最短パスが存在する\} \\\}
$$

という DP テーブルが， $s$ からの距離が小さい方から見ると $O(n + m)$ で埋められる．解は明らかに $dp\_t$ となる．

埋める上で考えるべき遷移は 4 種類ある． $u \\in V$ を「 $v$ と隣接し，かつ $st$ 最短パス $s \\to u \\to v \\to t$ が存在する」ものとすると，以下の通り．

1.  $x = y = v$ とする．
2.  $x, y$ 共に，パス $su$ から貰ってくる．
3.  $x = v$ とし， $y$ はパス $su$ から貰ってくる．
4.  $y = v$ とし， $x$ はパス $su$ から貰ってくる．

1 は簡単．2 は単純に $dp\_u$ で緩和すればいい．
そして 3, 4 の遷移を行うために，追加で以下の DP テーブルを持つ必要がある．

$$
dpa\_v = \\min \\\{ dis(a, x) \\mid
\\text\{$x$を通る$sv$最短パスが存在する\} \\\} \\\\
dpb\_v = \\min \\\{ dis(b, y) \\mid
\\text\{$y$を通る$sv$最短パスが存在する\} \\\}
$$

$dpb$ が 3， $dpa$ が 4 で必要となる．これら 2 つの更新方法は， $dp$ から 3, 4 の遷移がなくなるだけ．

確かにこれで解けることは分かるのだが，なぜこのような DP テーブルを考えたくなるのかが全然分からない．典型なのか，あるいはなんらかの道筋があるのか．

## 実装例

{{<code file="0.cpp" language="cpp">}}
