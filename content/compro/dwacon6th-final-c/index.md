---
title: "第 6 回 ドワンゴからの挑戦状 本選 C - Tree Shrinking"
date: 2020-02-14
tags: [atcoder]
links:
  - label: "Problem link"
    url: "https://atcoder.jp/contests/dwacon6th-final/tasks/dwacon6th_final_c"
  - label: "My Submission"
    url: "https://atcoder.jp/contests/dwacon6th-final/submissions/10090069"
---

## 問題

木 $G = (V, E)$ が与えられる．この木に対して以下の操作を $n - 1$ 回行う．最初スコアは $0$ である．

- $e = uv \\in E$ を当確率でランダムに選ぶ．
- $deg(u) \\cdot deg(v)$ がスコアに加算される．
- $e$ を縮約する．

最終的なスコアの期待値を求めよ．

### 制約

- $2 \\leq |V| \\leq 10\^5$

## 考察

期待値の積ということで，各辺対 $e\_1, e\_2 \\in E$ の「スコアへの寄与の期待値」，言い換えると「操作中に $e\_1, e\_2$ 両方に接続する辺が選ばれる回数の期待値」が知りたくなる．**辺対は順序対ではない**，つまり $(e\_1, e\_2)$ と $(e\_2, e\_1)$ で 2 回カウントしないことに注意．

まず $e\_1, e\_2$ が隣接しているとき．この場合はどんな順番に操作をしても， $e\_1$ か $e\_2$ が操作対象になるときにちょうど 1 回だけカウントされる．よって期待値は $1$ ．$e\_1 = e\_2$ のケースも考えることに注意．

そうでない場合．2 辺間の距離を $d$ とすると，2 辺を両端とするパス内で 2 辺間の辺が先に全て選ばれた場合のみちょうど **2 回** カウントされる．よって期待値は $\\frac\{2\}\{\{\}\_\{d + 2\} C\_2\}$ ．

このままでも進められるのだが，後々考えやすくするために「辺対」と「その外側の頂点対」の間で一対一対応を作る．すると，スコアの期待値は以下の式で求まる．

$$
\\sum\_\{1 \\leq u \\lt v \\leq |V|\} e\_\{d(u, v)\} \\quad
\\left(
   e\_d =
   \\begin\{cases\}
       1                  & (d \\leq 2) \\\\
       \\frac\{2\}\{\{\}\_d C\_2\} & (d \\gt 2)
   \\end\{cases\}
\\right)
$$

よって 2 点対間の距離分布が分かれば，それに適当な係数 $e\_d$ を掛けることで解が求まる．

距離分布については，蟻本 P.321 に部分問題である「距離 $k$ 以下の頂点対の個数」を重心分解で求める方法が載っている．今回も基本的な方針はこれと同じ．

ある 2 つの部分木の距離分布 $(a\_d), (b\_d)$ が与えられたとする．このとき，これら 2 つの部分木をマージしたときの距離分布を $(c\_d)$ とすると，

$$
c\_d = \\sum\_\{0 \\leq d\' \\leq d\} a\_\{d\'\} b\_\{d - d\'\}
$$

となる．これはまんま和に関する畳み込みなので，**FFT**で高速化できる．ただこれを全部分木対に対して計算すると遅いので，累積和を取りながらやる必要がある．なぜか次数が小さい方からマージすると速くなる．

## 実装例

1 つ 1 つの処理はライブラリに丸投げすることを意識すると，意外と考えることは少ない．

{{<code file="0.cpp" language="cpp">}}
